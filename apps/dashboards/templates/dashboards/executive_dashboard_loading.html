{% extends "dashboards/base.html" %}
{% load static %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1 class="dashboard-title">{{ title }}</h1>
        <div class="dashboard-filters">
            <div class="filter-group">
                <label class="filter-label">Product</label>
                <select name="product" class="filter-select">
                    <option value="">All Products</option>
                    {% for product in products %}
                        <option value="{{ product.id }}" {% if selected_product == product.id|stringformat:"s" %}selected{% endif %}>
                            {{ product.hierarchy_path }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Environment</label>
                <select name="environment" class="filter-select">
                    <option value="">All Environments</option>
                    {% for env in environments %}
                        <option value="{{ env }}" {% if selected_environment == env %}selected{% endif %}>
                            {{ env|title }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Loading Placeholder -->
    <div id="dashboard-loading-placeholder">
        <div class="chart-container">
            <div style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 3rem; margin-bottom: 20px;">‚ö°</div>
                <h3 style="margin-bottom: 15px;">Preparing Your Executive Dashboard</h3>
                <p style="color: #6b7280; margin-bottom: 30px;">
                    Aggregating data from Sentry, JIRA, and SonarCloud systems...
                </p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0;">
                    <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 1.5rem; margin-bottom: 10px;">üîç</div>
                        <div style="font-weight: 600;">Sentry Issues</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">Analyzing 525 issues</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 1.5rem; margin-bottom: 10px;">üé´</div>
                        <div style="font-weight: 600;">JIRA Tickets</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">Processing 2,567 tickets</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 1.5rem; margin-bottom: 10px;">üìä</div>
                        <div style="font-weight: 600;">Quality Metrics</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">Calculating health scores</div>
                    </div>
                </div>
                
                <div class="loading-progress" style="width: 400px; margin: 0 auto;">
                    <div class="loading-progress-bar"></div>
                </div>
                
                <p style="color: #6b7280; font-size: 0.875rem; margin-top: 20px;">
                    This may take a few seconds for the first load. Subsequent loads will be much faster thanks to caching.
                </p>
            </div>
        </div>
    </div>

    <!-- Dashboard Content (will be populated via AJAX) -->
    <div id="dashboard-content" style="display: none;">
        <!-- Content will be loaded here -->
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load dashboard data via AJAX
    const ajaxUrl = '{{ ajax_url|safe }}';
    
    fetch(ajaxUrl)
        .then(response => response.json())
        .then(data => {
            // Hide loading placeholder
            document.getElementById('dashboard-loading-placeholder').style.display = 'none';
            
            // Show content area
            const contentArea = document.getElementById('dashboard-content');
            contentArea.style.display = 'block';
            
            // Populate with actual dashboard content
            contentArea.innerHTML = generateDashboardHTML(data);
            
            // Initialize charts if needed
            if (typeof Chart !== 'undefined') {
                initializeCharts(data);
            }
            
            // Show loading time info
            if (data.loading_time) {
                console.log(`Dashboard loaded in: ${data.loading_time}`);
                const indicator = document.createElement('div');
                indicator.style.cssText = 'position:fixed;top:10px;right:10px;background:#10b981;color:white;padding:8px 12px;border-radius:4px;font-size:0.875rem;z-index:1000;';
                indicator.textContent = `Loaded in ${data.loading_time}`;
                document.body.appendChild(indicator);
                setTimeout(() => indicator.remove(), 3000);
            }
        })
        .catch(error => {
            console.error('Dashboard loading error:', error);
            document.getElementById('dashboard-loading-placeholder').innerHTML = `
                <div class="chart-container">
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">‚ùå</div>
                        <h3 style="margin-bottom: 15px; color: #dc3545;">Loading Error</h3>
                        <p style="color: #6b7280;">
                            Failed to load dashboard data. Please refresh the page to try again.
                        </p>
                        <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Refresh Page
                        </button>
                    </div>
                </div>
            `;
        });
});

function generateDashboardHTML(data) {
    // Generate the dashboard HTML from the loaded data
    // This is a simplified version - in production you'd want more sophisticated templating
    return `
        <div class="dashboard-grid">
            ${data.summary_cards.map(card => `
                <div class="metric-card ${card.color}">
                    <div class="metric-card-header">
                        <span class="metric-title">${card.title}</span>
                        <span class="metric-icon">${getCardIcon(card.icon)}</span>
                    </div>
                    <div class="metric-value">${card.value}</div>
                    ${card.subtitle ? `<div class="metric-subtitle">${card.subtitle}</div>` : ''}
                </div>
            `).join('')}
        </div>
        
        <div class="chart-container">
            <h3 class="chart-title">Issue Trends (Last 30 Days)</h3>
            <canvas id="healthTrendsChart" width="400" height="150"></canvas>
        </div>
        
        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">Critical Issues</h3>
            </div>
            <div style="padding: 20px;">
                ${data.critical_issues.length > 0 ? 
                    data.critical_issues.map(issue => `
                        <div style="padding: 10px; border-bottom: 1px solid #e5e7eb;">
                            <strong>${issue.title.substring(0, 60)}...</strong><br>
                            <small style="color: #6b7280;">${issue.project} - ${issue.environment} - Count: ${issue.count}</small>
                        </div>
                    `).join('') :
                    '<p style="text-align: center; color: #6b7280;">No critical issues found</p>'
                }
            </div>
        </div>
    `;
}

function getCardIcon(iconType) {
    const icons = {
        'products': 'üì¶',
        'issues': 'üî•',
        'links': 'üîó',
        'quality': '‚úÖ'
    };
    return icons[iconType] || 'üìä';
}

function initializeCharts(data) {
    // Initialize Chart.js charts with the loaded data
    const ctx = document.getElementById('healthTrendsChart');
    if (ctx && data.health_trends) {
        new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: data.health_trends.labels,
                datasets: data.health_trends.datasets
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'top' } }
            }
        });
    }
}
</script>
{% endblock %}